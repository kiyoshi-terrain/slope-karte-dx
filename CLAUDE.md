# SlopeKarte

## プロジェクト概要
鉄道斜面点検用のExcelフォーム（斜面カルテ）を現場で編集できるPWAアプリ。
Railway slope inspection & disaster prevention.
現場で写真撮影・コメント入力し、そのままExcelに保存できることが最大の価値。

### 対象プラットフォーム
- **iOS** (iPhone / iPad + Safari) — ダウンロード保存
- **Android** (タブレット / スマホ + Chrome) — 上書き保存（File System Access API）
- 単一コードベースで両対応。プラットフォーム固有の分岐は保存処理のみ。
- 手書き機能は将来的にPointerEvent APIで統一し、Apple Pencil / スタイラス両対応とする。

## デプロイ
- URL: https://fluffy-hummingbird-4844eb.netlify.app
- ホスティング: Netlify（ドラッグ&ドロップでデプロイ）
- 単一ファイル構成（index.html に HTML/CSS/JS すべて含む）

## 技術スタック
- HTML5 / JavaScript / CSS（フレームワーク不使用）
- ExcelJS 4.4.0（CDN経由） - Excel読み書き
- PWA（Service Worker, manifest.json）
- xlsx-populate 1.21.0（CDN経由） - Excel暗号化/復号（AES-256）
- JSZip 3.10.1（CDN経由） - xlsx-populate通過後のZIPシート参照修正
- Web Crypto API - PIN認証のSHA-256ハッシュ
- MSAL.js 2.38.0 - Microsoft認証（OneDrive版のみ、未実装）

## Excelテンプレート構造（重要）

### シート構成
| シート名 | 用途 |
|---------|------|
| BL瑜18 comments | コメントシート |
| BL瑜18 fig Top | 平面図 |
| BL瑜18 fig Side | 断面図 |
| BL瑜18 fig Photo | 写真図 |
| BL瑜18 Photo | **写真シート（メイン編集対象）** |

### 写真シート「BL瑜18 Photo」の構造
- **3列構造**: A列(col=1), V列(col=22), AQ列(col=43)
- 各列の幅: 約19列分（col 1→20, 22→41, 43→62）
- **写真ラベル行**: `（写真ア）` `(写真イ)` など（全角・半角括弧両方あり）
- **コメント行**: ラベル行の次行。`（コメント）\n内容...` の形式
- コメントは結合セルで複数行にまたがる（同じ内容が繰り返される）

### 写真配置（実測値）
| 項目 | 値 |
|------|-----|
| 画像高さ | 約22.5行分 |
| 画像幅 | 約19列分 |
| 配置 | ラベル行の直上 |
| 列幅 | 3.796875（全列共通、保存時に維持必須） |

### ラベル行の位置
```
行27:  写真ア(col=1)  写真イ(col=22)  写真ウ(col=43)
行60:  写真エ(col=1)  写真オ(col=22)  写真カ(col=43)
行96:  写真キ(col=1)  写真ク(col=22)  写真ケ(col=43)
行129: 写真コ(col=1)  写真サ(col=22)  写真シ(col=43)
行165: 写真ス(col=1)  写真セ(col=22)  写真ソ(col=43)
行198: 写真タ(col=1)  写真チ(col=22)  写真ツ(col=43)
行234: 写真テ(col=1)  写真ト(col=22)  写真ナ(col=43)
行267: 写真ニ(col=1)  写真ヌ(col=22)  写真ネ(col=43)
--- ここから空き枠（ダミー） ---
行303: 写真ノ(col=1)  写真ハ(col=22)  写真ヒ(col=43)
行336: 写真フ(col=1)  写真ヘ(col=22)  写真ホ(col=43)
行372: 写真マ(col=1)  写真ミ(col=22)  写真ム(col=43)
行405: 写真メ(col=1)  写真モ(col=22)  写真ヤ(col=43)
行441: 写真ユ(col=1)  写真ヨ(col=22)  写真ラ(col=43)
行474: 写真リ(col=1)  写真ル(col=22)  写真レ(col=43)
行510: 写真ロ(col=1)  写真ワ(col=22)  写真ヲ(col=43)
行543: 写真ン(col=1)  写真アア(col=22) 写真イイ(col=43)
```
合計48枠（既存24枚 + ダミー24枠）

### 写真ラベルの五十音順
ア,イ,ウ,エ,オ,カ,キ,ク,ケ,コ,サ,シ,ス,セ,ソ,タ,チ,ツ,テ,ト,ナ,ニ,ヌ,ネ,ノ,ハ,ヒ,フ,ヘ,ホ,マ,ミ,ム,メ,モ,ヤ,ユ,ヨ,ラ,リ,ル,レ,ロ,ワ,ヲ,ン,アア,イイ

## 実装済み機能
- ✅ Excel読み込み（ExcelJS）
- ✅ Photoシート自動検出（"Photo"含む＆"fig"含まないシート）
- ✅ 3列構造の写真シート解析
- ✅ 画像のアンカー位置ベースマッチング（列グループ＋最近傍ラベル）
- ✅ 既存写真・コメント表示
- ✅ ダミー枠（新規写真用）表示
- ✅ カメラ撮影/写真選択
- ✅ コメント編集・保存
- ✅ 画像のExcel保存（正確な位置配置: 22.5行×19列）
- ✅ 列幅保持（読み込み時に保存→書き出し前に復元）
- ✅ isDummy判定（画像もコメントもない場合のみダミー）
- ✅ PIN認証（4桁数字、初回設定型、SHA-256ハッシュでlocalStorage保存）
- ✅ Excel暗号化/復号（xlsx-populate、PINをパスワードとして使用）

## 未実装・今後のタスク

### BL瑜18 Photo（写真シート）← 現在の主要開発対象
- 🔶 写真の途中挿入＆自動ずらし機能（最優先）
- 🔶 OneDrive版の実機テスト
- 🔶 手書きアノテーション機能
- 🔶 オフライン対応強化

### BL瑜18 comments（コメントシート）
- 各セル内のコメントを現場で直接編集
- スタイラス/Apple Pencilでのペン入力（手書き記入、PointerEvent API）
- 枠外セルへの写真＋コメント挿入（臨時メモ用）

### BL瑜18 fig Top（平面図）/ BL瑜18 fig Side（断面図）
- スタイラス/Apple Pencilでの手書きメモ描画（図面上に直接書き込み、PointerEvent API）
- 音声入力によるメモ記入
- ポイントマーカー設置 → そのマーカー位置から写真撮影
- マーカーとPhotoシートの写真を連携

### BL瑜18 fig Photo（写真撮影位置図）
- 平面図上に写真の撮影位置を示す図
- 赤いマーカー（ア、イ、ウ...）が各写真の撮影地点に対応
- マーカーをタップ → BL瑜18 Photoの対応する写真にジャンプ
- 新規写真追加時にマーカーも自動配置（将来目標）

### 開発方針
- 「先ずは動かしてみる」を基本スタンスとする
- 各シートの詳細仕様は実装しながら詰めていく
- BL瑜18 Photo を最初に完成させ、他シートに展開する

## 既知の注意点

### ExcelJS の癖
- `sheet.getImages()` の画像順序はExcel内部の格納順で、表示順と一致しない
- 画像のアンカー座標（tl.row, tl.col）は浮動小数点で微妙にずれる（3.409 vs 3.424 など）
- 保存時に列幅がデフォルト値に戻ることがある → 明示的な復元が必要
- セル値がリッチテキスト（richText配列）の場合がある → getCellText ヘルパー関数で対応済み

### Excel テンプレートの癖
- 写真ラベルの括弧が全角`（）`と半角`()`の両方が混在する
- コメントセルは結合セルで、同じ内容が複数行に繰り返される
- 「調査結果写真」「調査写真」など、写真ラベルではないがキーワードを含むセルがある → 除外条件必要

## コーディング規約
- 単一ファイル構成を維持（index.html に全て含める）
- ExcelJSはCDN経由で読み込み（ビルドツール不使用）
- iOS / Android 両対応を前提に実装（タッチUI、safe-area対応）
- プラットフォーム固有の分岐は最小限に（保存処理のFile System Access API分岐のみ）
- ダークテーマ（背景 #1a1a2e、カード #2a2a4a、アクセント #667eea）

## デモファイル
- Demo_New.xlsx - 24枚の既存写真 + 24枠のダミー
