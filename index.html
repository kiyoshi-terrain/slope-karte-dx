<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SlopeKarte">
  <meta name="theme-color" content="#007934">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <title>SlopeKarte</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
      background: #0f1a14;
      color: #eee;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    html {
      height: -webkit-fill-available;
    }
    
    .header {
      background: linear-gradient(135deg, #007934 0%, #005a27 100%);
      padding: 12px 16px;
      padding-top: calc(12px + env(safe-area-inset-top));
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-logo {
      height: 22px;
      opacity: 0.9;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-appearance: none;
    }
    
    .btn:active {
      transform: scale(0.95);
      background: rgba(255,255,255,0.3);
    }
    
    .btn-primary {
      background: #00a550;
    }
    
    .container {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 80px;
    }
    
    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç”»é¢ */
    .file-select {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
      text-align: center;
      padding: 20px;
    }
    
    .file-drop-zone {
      border: 3px dashed #00a550;
      border-radius: 20px;
      padding: 50px 30px;
      background: rgba(0, 165, 80, 0.1);
      cursor: pointer;
      transition: all 0.3s;
      max-width: 400px;
      width: 100%;
    }
    
    .file-drop-zone:active {
      background: rgba(0, 165, 80, 0.2);
      transform: scale(0.98);
    }
    
    .file-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }
    
    .file-drop-zone h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .file-drop-zone p {
      color: #aaa;
      font-size: 14px;
    }
    
    #file-input {
      display: none;
    }
    
    /* ã‚·ãƒ¼ãƒˆé¸æŠã‚¿ãƒ– */
    .sheet-tabs {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding: 12px 0;
      margin-bottom: 16px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .sheet-tabs::-webkit-scrollbar {
      display: none;
    }
    
    .sheet-tab {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #ccc;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .sheet-tab:active {
      transform: scale(0.95);
    }
    
    .sheet-tab.active {
      background: #00a550;
      color: white;
    }
    
    /* å†™çœŸã‚°ãƒªãƒƒãƒ‰ */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    
    @media (max-width: 600px) {
      .photo-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .photo-card {
      background: #1a2b20;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .photo-card.is-dummy {
      border: 2px dashed #00a550;
      opacity: 0.8;
    }
    
    .photo-card.is-dummy:hover {
      opacity: 1;
    }
    
    .photo-frame {
      aspect-ratio: 4/3;
      background: #0f1a14;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .photo-frame:active {
      opacity: 0.8;
    }
    
    .photo-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-frame .placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #666;
    }
    
    .photo-frame .placeholder-icon {
      font-size: 40px;
      margin-bottom: 8px;
    }
    
    .photo-label {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: bold;
    }
    
    .photo-label.dummy {
      background: #00a550;
    }
    
    .photo-info {
      padding: 12px;
    }
    
    .photo-info h3 {
      font-size: 13px;
      color: #00a550;
      margin-bottom: 6px;
    }
    
    .comment-input {
      width: 100%;
      background: #0f1a14;
      border: 1px solid #444;
      border-radius: 8px;
      color: #eee;
      padding: 10px;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      line-height: 1.5;
    }
    
    .comment-input:focus {
      outline: none;
      border-color: #00a550;
    }
    
    .comment-input::placeholder {
      color: #666;
    }
    
    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆ */
    .action-sheet-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    
    .action-sheet-backdrop.active {
      display: block;
    }
    
    .action-sheet {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a2b20;
      border-radius: 16px 16px 0 0;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      z-index: 1000;
    }
    
    .action-sheet.active {
      display: block;
    }
    
    .action-sheet h3 {
      font-size: 14px;
      color: #888;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .action-btn {
      width: 100%;
      padding: 16px;
      border: none;
      background: #243d2c;
      color: #fff;
      font-size: 16px;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .action-btn:active {
      background: #2f5038;
    }
    
    .action-btn-cancel {
      background: transparent;
      color: #ff4757;
    }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
    .status-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a2b20;
      padding: 10px 16px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display: none;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    
    .status-bar.active {
      display: flex;
    }
    
    .status-bar .status {
      color: #00a550;
    }
    
    .status-bar .info {
      color: #aaa;
      font-size: 12px;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .loading.active {
      display: flex;
    }
    
    .spinner {
      width: 44px;
      height: 44px;
      border: 4px solid #333;
      border-top-color: #00a550;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading p {
      margin-top: 16px;
      color: #aaa;
      font-size: 14px;
    }
    
    /* å†™çœŸå…¥åŠ› */
    .photo-file-input {
      display: none;
    }


    
    /* ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± */
    .current-file {
      background: #1a2b20;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .current-file-icon {
      font-size: 32px;
    }
    
    .current-file-info {
      flex: 1;
    }
    
    .current-file-name {
      font-size: 15px;
      font-weight: 600;
    }
    
    .current-file-path {
      font-size: 12px;
      color: #888;
    }
    
    /* çµ±è¨ˆæƒ…å ± */
    .stats {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #aaa;
      flex-wrap: wrap;
    }
    
    .stats span {
      background: rgba(255,255,255,0.1);
      padding: 6px 12px;
      border-radius: 6px;
    }

    /* PINèªè¨¼ç”»é¢ */
    .pin-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0f1a14;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .pin-screen.hidden {
      display: none;
    }

    .pin-lock-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .pin-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #fff;
    }

    .pin-subtitle {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 24px;
      text-align: center;
    }

    .pin-error {
      color: #ff6b6b;
      font-size: 13px;
      min-height: 20px;
      margin-bottom: 8px;
      transition: opacity 0.3s;
    }

    .pin-dots {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
    }

    .pin-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #00a550;
      background: transparent;
      transition: all 0.15s;
    }

    .pin-dot.filled {
      background: #00a550;
      transform: scale(1.1);
    }

    .pin-dot.error {
      border-color: #ff6b6b;
      background: #ff6b6b;
      animation: pinShake 0.4s;
    }

    @keyframes pinShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
    }

    .pin-keypad {
      display: grid;
      grid-template-columns: repeat(3, 72px);
      gap: 12px;
    }

    .pin-key {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-size: 28px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      -webkit-appearance: none;
      user-select: none;
      -webkit-user-select: none;
    }

    .pin-key:active {
      background: rgba(0, 165, 80, 0.4);
      transform: scale(0.95);
    }

    .pin-key.fn {
      font-size: 14px;
      font-weight: 400;
      border-color: transparent;
      background: transparent;
    }

    .pin-key.fn:active {
      background: rgba(255,255,255,0.1);
    }

    .pin-reset {
      margin-top: 32px;
      color: #00a550;
      font-size: 13px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 16px;
      -webkit-appearance: none;
    }

    .pin-reset:active {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- PINèªè¨¼ç”»é¢ -->
  <div class="pin-screen" id="pin-screen">
    <div class="pin-lock-icon">ğŸ”’</div>
    <div class="pin-title" id="pin-title">PINã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
    <div class="pin-subtitle" id="pin-subtitle">4æ¡ã®æ•°å­—ã‚’å…¥åŠ›</div>
    <div class="pin-error" id="pin-error">&nbsp;</div>
    <div class="pin-dots">
      <div class="pin-dot" id="pin-dot-0"></div>
      <div class="pin-dot" id="pin-dot-1"></div>
      <div class="pin-dot" id="pin-dot-2"></div>
      <div class="pin-dot" id="pin-dot-3"></div>
    </div>
    <div class="pin-keypad">
      <button class="pin-key" onclick="pinInput('1')">1</button>
      <button class="pin-key" onclick="pinInput('2')">2</button>
      <button class="pin-key" onclick="pinInput('3')">3</button>
      <button class="pin-key" onclick="pinInput('4')">4</button>
      <button class="pin-key" onclick="pinInput('5')">5</button>
      <button class="pin-key" onclick="pinInput('6')">6</button>
      <button class="pin-key" onclick="pinInput('7')">7</button>
      <button class="pin-key" onclick="pinInput('8')">8</button>
      <button class="pin-key" onclick="pinInput('9')">9</button>
      <button class="pin-key fn" onclick="pinClear()">CLR</button>
      <button class="pin-key" onclick="pinInput('0')">0</button>
      <button class="pin-key fn" onclick="pinBackspace()">âŒ«</button>
    </div>
    <button class="pin-reset" id="pin-reset-btn" onclick="pinReset()" style="display:none;">PINã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <h1><svg class="header-logo" viewBox="0 0 120 40" fill="white"><text x="0" y="28" font-size="26" font-weight="bold" font-family="Arial, sans-serif">JRSE</text></svg> SlopeKarte</h1>
    <div class="header-actions" id="header-actions" style="display: none;">
      <button class="btn" onclick="closeFile()">é–‰ã˜ã‚‹</button>
      <button class="btn btn-primary" onclick="saveFile()">ğŸ”’ ä¿å­˜</button>
      <button class="btn" onclick="saveFileNoEncrypt()">ğŸ’¾ ä¿å­˜(æš—å·åŒ–ãªã—)</button>
      <button class="btn" onclick="saveFileAs()" id="save-as-btn" style="display:none;">ğŸ“¥ åˆ¥åä¿å­˜</button>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="container">
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç”»é¢ -->
    <div class="file-select" id="file-select">
      <div class="file-drop-zone" id="drop-zone">
        <div class="file-icon">ğŸ“</div>
        <h2>Karteã‚’é–‹ã</h2>
        <p>ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br>(OneDrive / iCloud / ãƒ­ãƒ¼ã‚«ãƒ«)</p>
        <input type="file" id="file-input" accept=".xlsx,.xls">
      </div>
    </div>

    <!-- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ç”»é¢ -->
    <div id="editor" style="display: none;">
      <div class="current-file" id="current-file">
        <span class="current-file-icon">ğŸ“Š</span>
        <div class="current-file-info">
          <div class="current-file-name" id="current-file-name">-</div>
          <div class="current-file-path" id="current-file-path">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«</div>
        </div>
      </div>
      <div class="sheet-tabs" id="sheet-tabs"></div>
      <div class="stats" id="stats"></div>
      <div class="photo-grid" id="photo-grid"></div>
    </div>
  </main>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
  <div class="status-bar" id="status-bar">
    <span class="status" id="status-text">æº–å‚™å®Œäº†</span>
    <span class="info" id="info-text"></span>
  </div>

  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆï¼ˆå†™çœŸé¸æŠæ–¹æ³•ï¼‰ -->
  <div class="action-sheet-backdrop" id="action-backdrop" onclick="closeActionSheet()"></div>
  <div class="action-sheet" id="action-sheet">
    <h3 id="action-sheet-title">å†™çœŸã‚’è¿½åŠ </h3>
    <button class="action-btn" onclick="openCamera()">
      ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±
    </button>
    <button class="action-btn" onclick="openPhotoLibrary()">
      ğŸ–¼ï¸ å†™çœŸã‚’é¸æŠ
    </button>
    <button class="action-btn action-btn-cancel" onclick="closeActionSheet()">
      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    </button>
  </div>

  <!-- å†™çœŸé¸æŠç”¨input -->
  <input type="file" id="photo-input" class="photo-file-input" accept="image/*">
  <input type="file" id="camera-input" class="photo-file-input" accept="image/*" capture="environment">

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="loading-text">èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
    let workbook = null;
    let currentFileName = null;
    let currentSheetName = null;
    let photoData = [];
    let currentPhotoIndex = null;
    let hasUnsavedChanges = false;
    let savedColumnWidths = {}; // ã‚·ãƒ¼ãƒˆã”ã¨ã®åˆ—å¹…ã‚’ä¿æŒ
    let savedRowHeights = {};   // ã‚·ãƒ¼ãƒˆã”ã¨ã®è¡Œé«˜ã•ã‚’ä¿æŒ
    let fileHandle = null; // File System Access APIç”¨ãƒãƒ³ãƒ‰ãƒ«
    let appPIN = null; // èªè¨¼æ¸ˆã¿PINï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ã€æš—å·åŒ–/å¾©å·ã«ä½¿ç”¨ï¼‰

    // File System Access APIå¯¾å¿œãƒã‚§ãƒƒã‚¯
    const supportsFileSystemAccess = ('showOpenFilePicker' in window);

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

    // ============================
    // PINèªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
    // ============================
    const PIN_HASH_KEY = 'slopeKartePINHash';
    let pinBuffer = '';
    let pinMode = 'auth'; // 'setup', 'setup-confirm', 'auth'
    let pinSetupFirst = ''; // è¨­å®šãƒ¢ãƒ¼ãƒ‰ã®1å›ç›®å…¥åŠ›å€¤

    // SHA-256ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
    async function sha256(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // PINç”»é¢åˆæœŸåŒ–
    function initPINScreen() {
      const pinScreen = document.getElementById('pin-screen');
      const savedHash = localStorage.getItem(PIN_HASH_KEY);

      if (savedHash) {
        // æ—¢ã«PINè¨­å®šæ¸ˆã¿ â†’ èªè¨¼ãƒ¢ãƒ¼ãƒ‰
        pinMode = 'auth';
        document.getElementById('pin-title').textContent = 'PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        document.getElementById('pin-subtitle').textContent = '4æ¡ã®æ•°å­—ã‚’å…¥åŠ›';
        document.getElementById('pin-reset-btn').style.display = 'inline-block';
      } else {
        // æœªè¨­å®š â†’ è¨­å®šãƒ¢ãƒ¼ãƒ‰
        pinMode = 'setup';
        document.getElementById('pin-title').textContent = 'PINã‚’è¨­å®šã—ã¦ãã ã•ã„';
        document.getElementById('pin-subtitle').textContent = '4æ¡ã®æ•°å­—ã‚’å…¥åŠ›';
        document.getElementById('pin-reset-btn').style.display = 'none';
      }
      pinScreen.classList.remove('hidden');
      pinBuffer = '';
      updatePINDots();
    }

    // ãƒ‰ãƒƒãƒˆè¡¨ç¤ºæ›´æ–°
    function updatePINDots() {
      for (let i = 0; i < 4; i++) {
        const dot = document.getElementById(`pin-dot-${i}`);
        dot.classList.toggle('filled', i < pinBuffer.length);
        dot.classList.remove('error');
      }
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆãƒ‰ãƒƒãƒˆæŒ¯å‹•ï¼‰
    function showPINError(msg) {
      document.getElementById('pin-error').textContent = msg;
      for (let i = 0; i < 4; i++) {
        document.getElementById(`pin-dot-${i}`).classList.add('error');
      }
      setTimeout(() => {
        pinBuffer = '';
        updatePINDots();
        document.getElementById('pin-error').innerHTML = '&nbsp;';
      }, 600);
    }

    // PINå…¥åŠ›
    function pinInput(digit) {
      if (pinBuffer.length >= 4) return;
      pinBuffer += digit;
      updatePINDots();

      if (pinBuffer.length === 4) {
        setTimeout(() => processPIN(), 150);
      }
    }

    // PINå‰Šé™¤
    function pinBackspace() {
      if (pinBuffer.length > 0) {
        pinBuffer = pinBuffer.slice(0, -1);
        updatePINDots();
      }
    }

    // PINã‚¯ãƒªã‚¢
    function pinClear() {
      pinBuffer = '';
      updatePINDots();
      document.getElementById('pin-error').innerHTML = '&nbsp;';
    }

    // PINå‡¦ç†ï¼ˆ4æ¡æƒã£ãŸæ™‚ï¼‰
    async function processPIN() {
      if (pinMode === 'setup') {
        // è¨­å®šãƒ¢ãƒ¼ãƒ‰: 1å›ç›®å…¥åŠ›
        pinSetupFirst = pinBuffer;
        pinMode = 'setup-confirm';
        document.getElementById('pin-title').textContent = 'ç¢ºèªã®ãŸã‚ã‚‚ã†ä¸€åº¦';
        document.getElementById('pin-subtitle').textContent = 'åŒã˜PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        pinBuffer = '';
        updatePINDots();
      } else if (pinMode === 'setup-confirm') {
        // è¨­å®šãƒ¢ãƒ¼ãƒ‰: 2å›ç›®å…¥åŠ›ï¼ˆç¢ºèªï¼‰
        if (pinBuffer === pinSetupFirst) {
          // ä¸€è‡´ â†’ ä¿å­˜ã—ã¦èªè¨¼å®Œäº†
          const hash = await sha256(pinBuffer);
          localStorage.setItem(PIN_HASH_KEY, hash);
          appPIN = pinBuffer;
          pinAuthenticated();
        } else {
          // ä¸ä¸€è‡´ â†’ ã‚„ã‚Šç›´ã—
          showPINError('PINãŒä¸€è‡´ã—ã¾ã›ã‚“');
          setTimeout(() => {
            pinMode = 'setup';
            document.getElementById('pin-title').textContent = 'PINã‚’è¨­å®šã—ã¦ãã ã•ã„';
            document.getElementById('pin-subtitle').textContent = '4æ¡ã®æ•°å­—ã‚’å…¥åŠ›';
            pinSetupFirst = '';
          }, 600);
        }
      } else if (pinMode === 'auth') {
        // èªè¨¼ãƒ¢ãƒ¼ãƒ‰
        const hash = await sha256(pinBuffer);
        const savedHash = localStorage.getItem(PIN_HASH_KEY);
        if (hash === savedHash) {
          appPIN = pinBuffer;
          pinAuthenticated();
        } else {
          showPINError('PINãŒé•ã„ã¾ã™');
        }
      }
    }

    // PINèªè¨¼æˆåŠŸ
    function pinAuthenticated() {
      const pinScreen = document.getElementById('pin-screen');
      pinScreen.classList.add('hidden');
      pinBuffer = '';
    }

    // PINãƒªã‚»ãƒƒãƒˆ
    function pinReset() {
      if (confirm('PINã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã¨ã€æš—å·åŒ–æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(PIN_HASH_KEY);
        appPIN = null;
        pinBuffer = '';
        pinSetupFirst = '';
        initPINScreen();
      }
    }

    // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«PINç”»é¢ã‚’è¡¨ç¤º
    initPINScreen();

    // ============================
    // Excelæš—å·åŒ–/å¾©å·ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆExcelãƒã‚¤ãƒ†ã‚£ãƒ–æš—å·åŒ– via xlsx-populateï¼‰
    // ============================
    // xlsx-populateã§Excelæ¨™æº–ã®AES-256æš—å·åŒ–ã‚’è¡Œã†ã€‚
    // ãŸã ã—xlsx-populateã¯ã‚·ãƒ¼ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãƒªãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€
    // æš—å·åŒ–å¾Œã«ZIPãƒ¬ãƒ™ãƒ«ã§workbook.xml.relsç­‰ã‚’å¾©å…ƒã™ã‚‹ä¿®æ­£ã‚’è¡Œã†ã€‚

    // ï¼ˆZIPä¿®æ­£é–¢æ•° fixZipSheetRefs ã¯ä¸‹è¨˜ã®å¾©å·å‡¦ç†å†…ã«å®šç¾©ï¼‰

    // xlsx-populateé€šéå¾Œã®ZIPã‚’ä¿®æ­£ï¼ˆContent_Typesãƒ™ãƒ¼ã‚¹ã§ã‚·ãƒ¼ãƒˆå‚ç…§ã‚’å¾©å…ƒï¼‰
    // å¾©å·æ™‚ã«ã¯savedZipMetadataãŒãªã„ãŸã‚ã€ZIPå†…ã®Content_Typesã‚’æ­£ã¨ã—ã¦ä½¿ã†
    async function fixZipSheetRefs(buffer) {
      try {
        const zip = await JSZip.loadAsync(buffer);

        // workbook.xml.relsã‹ã‚‰ç¾åœ¨ã®ã‚·ãƒ¼ãƒˆå‚ç…§ã‚’å–å¾—ï¼ˆxlsx-populateãŒãƒªãƒãƒƒãƒ—ã—ãŸç•ªå·ï¼‰
        const rels = await zip.files['xl/_rels/workbook.xml.rels'].async('string');
        const relsMatches = [...rels.matchAll(/Target="worksheets\/(sheet\d+\.xml)"/g)];
        const relsSheets = relsMatches.map(m => m[1]); // sheet1, sheet2, ...

        // Content_Typesã‹ã‚‰å…ƒã®ã‚·ãƒ¼ãƒˆå‚ç…§ã‚’å–å¾—ï¼ˆExcelJSãŒå‡ºåŠ›ã—ãŸæœ¬æ¥ã®ç•ªå·ï¼‰
        const ct = await zip.files['[Content_Types].xml'].async('string');
        const ctMatches = ct.match(/PartName="\/xl\/worksheets\/sheet\d+\.xml"/g) || [];
        const ctSheets = ctMatches.map(m => m.match(/sheet\d+\.xml/)[0]); // sheet9, sheet10, ...

        if (ctSheets.length === 0 || relsSheets.length === 0) return buffer;

        // ãƒªãƒãƒƒãƒ”ãƒ³ã‚°ãŒä¸è¦ã‹åˆ¤å®šï¼ˆå®Œå…¨ä¸€è‡´ãªã‚‰ä¿®æ­£ä¸è¦ï¼‰
        const relsSet = new Set(relsSheets);
        const ctSet = new Set(ctSheets);
        const needsFix = relsSheets.some(s => !ctSet.has(s)) || ctSheets.some(s => !relsSet.has(s));
        if (!needsFix) {
          console.log('ZIPä¿®æ­£ä¸è¦ï¼ˆã‚·ãƒ¼ãƒˆå‚ç…§ä¸€è‡´ï¼‰');
          return buffer;
        }

        console.log('ã‚·ãƒ¼ãƒˆãƒªãƒãƒƒãƒ”ãƒ³ã‚°æ¤œå‡º:', relsSheets, 'â†', ctSheets);

        // æˆ¦ç•¥: relsã®ç•ªå·ï¼ˆxlsx-populateãŒworkbook.xml.relsã§ä½¿ã†ç•ªå·ï¼‰ã‚’æ­£ã¨ã—ã¦ã€
        // å…ƒã®ç•ªå·ï¼ˆContent_Types/å®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã®å†…å®¹ã‚’relsã®ç•ªå·ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
        // relsSheets[i] â† ctSheets[i] ã®å¯¾å¿œé–¢ä¿‚

        const mapping = []; // { from: 'sheet9.xml', to: 'sheet1.xml' }
        for (let i = 0; i < Math.min(relsSheets.length, ctSheets.length); i++) {
          if (relsSheets[i] !== ctSheets[i]) {
            mapping.push({ from: ctSheets[i], to: relsSheets[i] });
          }
        }

        if (mapping.length === 0) return buffer;

        // 1. ã‚·ãƒ¼ãƒˆXMLã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå…ƒã®ã‚·ãƒ¼ãƒˆã®å®Ÿãƒ‡ãƒ¼ã‚¿ â†’ æ–°ã—ã„ç•ªå·ï¼‰
        for (const { from, to } of mapping) {
          const fromPath = 'xl/worksheets/' + from;
          const toPath = 'xl/worksheets/' + to;
          if (zip.files[fromPath]) {
            const content = await zip.files[fromPath].async('uint8array');
            zip.file(toPath, content);
            console.log(`ã‚·ãƒ¼ãƒˆXMLã‚³ãƒ”ãƒ¼: ${from} â†’ ${to} (${content.length} bytes)`);
          }
        }

        // 2. worksheet relsã‚‚ã‚³ãƒ”ãƒ¼ï¼ˆdrawingæ¥ç¶šã‚’ç¶­æŒï¼‰
        for (const { from, to } of mapping) {
          const fromRels = 'xl/worksheets/_rels/' + from + '.rels';
          const toRels = 'xl/worksheets/_rels/' + to + '.rels';
          if (zip.files[fromRels]) {
            const relsContent = await zip.files[fromRels].async('string');
            zip.file(toRels, relsContent);
            console.log(`ã‚·ãƒ¼ãƒˆrels ã‚³ãƒ”ãƒ¼: ${from}.rels â†’ ${to}.rels`);
          }
        }

        // 3. Content_Typesã‚’æ›´æ–°ï¼ˆå…ƒã®ç•ªå· â†’ æ–°ã—ã„ç•ªå·ï¼‰
        let fixedCt = ct;
        for (const { from, to } of mapping) {
          fixedCt = fixedCt.replace(
            new RegExp(`PartName="/xl/worksheets/${from.replace('.', '\\.')}"`, 'g'),
            `PartName="/xl/worksheets/${to}"`
          );
        }
        zip.file('[Content_Types].xml', fixedCt);

        // 4. å…ƒã®ã‚·ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨relsã‚’å‰Šé™¤ï¼ˆæ–°ã—ã„ç•ªå·ã«ã‚³ãƒ”ãƒ¼æ¸ˆã¿ãªã®ã§ä¸è¦ï¼‰
        const newSheetSet = new Set(relsSheets.map(s => 'xl/worksheets/' + s));
        const allSheetFiles = Object.keys(zip.files)
          .filter(f => /xl\/worksheets\/sheet\d+\.xml$/.test(f));
        for (const f of allSheetFiles) {
          if (!newSheetSet.has(f)) {
            zip.remove(f);
            console.log('ä½™è¨ˆãªã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤:', f);
          }
        }
        // å…ƒã®relsã‚‚å‰Šé™¤
        const newRelsSet = new Set(relsSheets.map(s => 'xl/worksheets/_rels/' + s + '.rels'));
        const allRelsFiles = Object.keys(zip.files)
          .filter(f => /xl\/worksheets\/_rels\/sheet\d+\.xml\.rels$/.test(f));
        for (const f of allRelsFiles) {
          if (!newRelsSet.has(f)) {
            zip.remove(f);
            console.log('ä½™è¨ˆãªrelsã‚’å‰Šé™¤:', f);
          }
        }

        const result = await zip.generateAsync({
          type: 'arraybuffer',
          compression: 'DEFLATE',
          compressionOptions: { level: 6 }
        });
        console.log('ZIPä¿®æ­£å®Œäº†');
        return result;
      } catch (e) {
        console.warn('ZIPä¿®æ­£ã‚¹ã‚­ãƒƒãƒ—:', e);
        return buffer;
      }
    }

    // ExcelJSã®writeBufferãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…åˆ—ã«ã‚‚customWidth="1"ã‚’ä»˜ã‘ã‚‹å•é¡Œã‚’ä¿®æ­£
    // Excelã§ã®è¡¨ç¤ºåˆ—å¹…ãŒå¤‰ã‚ã‚‹ï¼ˆ2.8â†’3.0ï¼‰ã®ã‚’é˜²ã
    async function fixExcelJSColWidths(buffer) {
      try {
        const zip = await JSZip.loadAsync(buffer);
        const sheetFiles = Object.keys(zip.files)
          .filter(f => /xl\/worksheets\/sheet\d+\.xml$/.test(f));

        for (const f of sheetFiles) {
          let xml = await zip.files[f].async('string');
          // width="9"ï¼ˆExcelã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ—å¹…ï¼‰ã®colè¦ç´ ã‹ã‚‰customWidth="1"ã‚’é™¤å»
          // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…ã«customWidthãŒä»˜ã„ã¦ã„ãªã„
          const modified = xml.replace(
            /(<col [^>]*width="9"[^>]*) customWidth="1"([^>]*\/>)/g,
            '$1$2'
          ).replace(
            /(<col [^>]*)customWidth="1" ([^>]*width="9"[^>]*\/>)/g,
            '$1$2'
          );
          if (modified !== xml) {
            zip.file(f, modified);
          }
        }

        return await zip.generateAsync({
          type: 'arraybuffer',
          compression: 'DEFLATE',
          compressionOptions: { level: 6 }
        });
      } catch (e) {
        console.warn('åˆ—å¹…ä¿®æ­£ã‚¹ã‚­ãƒƒãƒ—:', e);
        return buffer;
      }
    }

    // å¾©å·å‡¦ç†ï¼ˆExcelãƒã‚¤ãƒ†ã‚£ãƒ–æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’PINã§å¾©å·ï¼‰
    async function decryptIfNeeded(arrayBuffer) {
      if (!appPIN) return arrayBuffer;

      // Excelãƒã‚¤ãƒ†ã‚£ãƒ–æš—å·åŒ–ã¯CFBå½¢å¼ï¼ˆå…ˆé ­ãƒã‚¤ãƒˆãŒ 0xD0 0xCFï¼‰
      const header = new Uint8Array(arrayBuffer, 0, 2);
      const isCFB = (header[0] === 0xD0 && header[1] === 0xCF);

      if (!isCFB) {
        // ZIPãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆPK = 0x50 0x4Bï¼‰â†’ éæš—å·åŒ–xlsx
        console.log('éæš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ï¼ˆãã®ã¾ã¾èª­ã¿è¾¼ã¿ï¼‰');
        return arrayBuffer;
      }

      try {
        // xlsx-populateã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãå¾©å·
        showLoading('æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·ä¸­...');
        const xlsxWb = await XlsxPopulate.fromDataAsync(arrayBuffer, { password: appPIN });
        const decryptedBuffer = await xlsxWb.outputAsync({ type: 'arraybuffer' });
        console.log('æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’PINã§å¾©å·ã—ã¾ã—ãŸ');

        // xlsx-populateã®ã‚·ãƒ¼ãƒˆãƒªãƒãƒƒãƒ”ãƒ³ã‚°å•é¡Œã‚’ä¿®æ­£
        const fixedBuffer = await fixZipSheetRefs(decryptedBuffer);
        return fixedBuffer;
      } catch (e) {
        console.error('å¾©å·å¤±æ•—:', e);
        throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚PINã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§å†è¨­å®šã—ã¦ãã ã•ã„ã€‚');
      }
    }

    // æš—å·åŒ–å‡¦ç†ï¼ˆExcelJSã®writeBufferå‡ºåŠ›ã‚’Excelãƒã‚¤ãƒ†ã‚£ãƒ–æš—å·åŒ–ï¼‰
    // xlsx-populateã¯ã‚·ãƒ¼ãƒˆã‚’ãƒªãƒãƒƒãƒ—ã™ã‚‹ãŸã‚ã€æš—å·åŒ–â†’å¾©å·â†’ä¿®æ­£â†’å†æš—å·åŒ–ã®æ‰‹é †ã§
    // Excelã§ã‚‚æ­£ã—ãé–‹ã‘ã‚‹æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
    async function encryptBuffer(buffer) {
      if (!appPIN) return buffer;

      try {
        // Step 1: xlsx-populateã§ä¸€åº¦ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼ï¼ˆãƒªãƒãƒƒãƒ—ãŒç™ºç”Ÿï¼‰
        const xlsxWb = await XlsxPopulate.fromDataAsync(buffer);
        const passedBuffer = await xlsxWb.outputAsync({ type: 'arraybuffer' });

        // Step 2: ãƒªãƒãƒƒãƒ—ã•ã‚ŒãŸZIPã‚’ä¿®æ­£
        const fixedBuffer = await fixZipSheetRefs(passedBuffer);

        // Step 3: ä¿®æ­£æ¸ˆã¿ZIPã‚’xlsx-populateã§æš—å·åŒ–
        // ä¿®æ­£æ¸ˆã¿ãªã®ã§å†åº¦ãƒªãƒãƒƒãƒ—ã•ã‚Œã¦ã‚‚ sheet1=sheet1 ã§ä¸€è‡´ã™ã‚‹
        const xlsxWb2 = await XlsxPopulate.fromDataAsync(fixedBuffer);
        const encrypted = await xlsxWb2.outputAsync({ password: appPIN, type: 'arraybuffer' });
        console.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’PINã§Excelãƒã‚¤ãƒ†ã‚£ãƒ–æš—å·åŒ–ã—ã¾ã—ãŸï¼ˆZIPä¿®æ­£æ¸ˆã¿ï¼‰');
        return encrypted;
      } catch (e) {
        console.error('æš—å·åŒ–å¤±æ•—:', e);
        throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®æš—å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }

    // DOMè¦ç´ 
    const fileSelect = document.getElementById('file-select');
    const editor = document.getElementById('editor');
    const headerActions = document.getElementById('header-actions');
    const statusBar = document.getElementById('status-bar');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const sheetTabs = document.getElementById('sheet-tabs');
    const photoGrid = document.getElementById('photo-grid');
    const loading = document.getElementById('loading');
    const actionSheet = document.getElementById('action-sheet');
    const actionBackdrop = document.getElementById('action-backdrop');
    const photoInput = document.getElementById('photo-input');
    const cameraInput = document.getElementById('camera-input');

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    dropZone.addEventListener('click', async () => {
      if (supportsFileSystemAccess) {
        // File System Access APIå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ â†’ ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«å–å¾—
        try {
          const [handle] = await window.showOpenFilePicker({
            types: [{
              description: 'Excel ãƒ•ã‚¡ã‚¤ãƒ«',
              accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }
            }],
            multiple: false
          });
          fileHandle = handle;
          const file = await handle.getFile();
          loadExcelFile(file);
        } catch (err) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ
          if (err.name !== 'AbortError') {
            console.error('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼:', err);
          }
        }
      } else {
        // éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ â†’ å¾“æ¥ã®input
        fileInput.click();
      }
    });
    fileInput.addEventListener('change', handleFileSelect);
    photoInput.addEventListener('change', handlePhotoSelect);
    cameraInput.addEventListener('change', handlePhotoSelect);

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©ï¼ˆå¾“æ¥ã®inputç”¨ï¼‰
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        fileHandle = null; // inputã‹ã‚‰é¸ã‚“ã å ´åˆã¯ãƒãƒ³ãƒ‰ãƒ«ãªã—
        loadExcelFile(file);
      }
    }

    // Excelãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    async function loadExcelFile(file) {
      showLoading('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

      try {
        const arrayBuffer = await file.arrayBuffer();

        // æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å·ã‚’è©¦è¡Œ
        let loadBuffer;
        try {
          loadBuffer = await decryptIfNeeded(arrayBuffer);
        } catch (decryptError) {
          hideLoading();
          alert(decryptError.message);
          return;
        }

        workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(loadBuffer);
        
        // å…¨ã‚·ãƒ¼ãƒˆã®åˆ—å¹…ãƒ»è¡Œé«˜ã•ã‚’ä¿å­˜ï¼ˆExcelJSãŒä¿å­˜æ™‚ã«å¤‰æ›´ã™ã‚‹ã®ã‚’é˜²ãï¼‰
        savedColumnWidths = {};
        savedRowHeights = {};
        workbook.worksheets.forEach(ws => {
          savedColumnWidths[ws.name] = {};
          for (let c = 1; c <= ws.columnCount; c++) {
            const col = ws.getColumn(c);
            if (col.width) {
              savedColumnWidths[ws.name][c] = col.width;
            }
          }
          savedRowHeights[ws.name] = {};
          ws.eachRow({ includeEmpty: true }, (row, rowNumber) => {
            if (row.height) {
              savedRowHeights[ws.name][rowNumber] = row.height;
            }
          });
        });
        
        currentFileName = file.name;
        document.getElementById('current-file-name').textContent = file.name;
        
        fileSelect.style.display = 'none';
        editor.style.display = 'block';
        headerActions.style.display = 'flex';
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€Œåˆ¥åä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('save-as-btn').style.display = fileHandle ? 'inline-block' : 'none';
        statusBar.classList.add('active');
        
        renderSheetTabs();
        
        // Photoã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•é¸æŠï¼ˆfigã‚’å«ã¾ãªã„ã‚‚ã®ï¼‰
        const photoSheet = workbook.worksheets.find(s => 
          s.name.includes('Photo') && !s.name.includes('fig')
        );
        if (photoSheet) {
          selectSheet(photoSheet.name);
        } else if (workbook.worksheets.length > 0) {
          selectSheet(workbook.worksheets[0].name);
        }
        
        setStatus('èª­ã¿è¾¼ã¿å®Œäº†', file.name);
        hideLoading();
      } catch (error) {
        console.error('Error loading Excel:', error);
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        hideLoading();
      }
    }

    // ã‚·ãƒ¼ãƒˆã‚¿ãƒ–æç”»
    function renderSheetTabs() {
      sheetTabs.innerHTML = '';
      workbook.worksheets.forEach(sheet => {
        const tab = document.createElement('button');
        tab.className = 'sheet-tab';
        tab.textContent = sheet.name;
        tab.onclick = () => selectSheet(sheet.name);
        sheetTabs.appendChild(tab);
      });
    }

    // ã‚·ãƒ¼ãƒˆé¸æŠ
    function selectSheet(sheetName) {
      currentSheetName = sheetName;
      
      document.querySelectorAll('.sheet-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === sheetName);
      });
      
      parseAndRenderSheet(sheetName);
    }

    // ã‚·ãƒ¼ãƒˆè§£æãƒ»æç”»
    function parseAndRenderSheet(sheetName) {
      const sheet = workbook.getWorksheet(sheetName);
      photoData = [];
      
      if (sheetName.includes('Photo') && !sheetName.includes('fig')) {
        parsePhotoSheet(sheet);
      } else {
        renderGenericSheet(sheet);
      }
    }

    // å†™çœŸã‚·ãƒ¼ãƒˆè§£æï¼ˆ3åˆ—æ§‹é€ å¯¾å¿œï¼‰
    function parsePhotoSheet(sheet) {
      showLoading('å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
      
      console.log('=== parsePhotoSheet é–‹å§‹ ===');
      console.log('sheet.rowCount:', sheet.rowCount);
      
      // ã‚»ãƒ«å€¤ã‚’å®‰å…¨ã«å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      function getCellText(cell) {
        if (!cell || !cell.value) return '';
        
        const val = cell.value;
        console.log('ã‚»ãƒ«å€¤ã®å‹:', typeof val, val);
        
        // ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆ
        if (typeof val === 'object') {
          if (val.richText && Array.isArray(val.richText)) {
            const text = val.richText.map(rt => rt.text || '').join('');
            console.log('ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ:', text.substring(0, 50));
            return text;
          }
          if (val.text) {
            console.log('val.text:', val.text);
            return String(val.text);
          }
          if (val.result !== undefined) {
            console.log('val.result:', val.result);
            return String(val.result);
          }
          // ãã®ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          try {
            const str = JSON.stringify(val);
            console.log('JSON:', str.substring(0, 100));
            return str;
          } catch (e) {
            return '';
          }
        }
        
        // é€šå¸¸ã®å€¤
        return String(val);
      }
      
      // ç”»åƒã‚’å–å¾—ã—ã¦ãƒãƒƒãƒ—åŒ–
      const images = sheet.getImages();
      console.log('ç”»åƒæ•°:', images.length);
      const imageDataList = [];
      
      images.forEach((img, idx) => {
        const imageId = img.imageId;
        const image = workbook.getImage(imageId);
        
        if (image && image.buffer) {
          const base64 = btoa(
            new Uint8Array(image.buffer)
              .reduce((data, byte) => data + String.fromCharCode(byte), '')
          );
          const dataUrl = `data:image/${image.extension || 'jpeg'};base64,${base64}`;
          
          // ã‚¢ãƒ³ã‚«ãƒ¼ä½ç½®ã‚’å–å¾—
          let row = 0, col = 0;
          if (img.range && img.range.tl) {
            row = img.range.tl.row;
            col = img.range.tl.col;
          }
          imageDataList.push({ dataUrl, row, col, index: idx });
        }
      });
      
      // 3åˆ—æ§‹é€ : Aåˆ—(1), Våˆ—(22), AQåˆ—(43)
      const photoCols = [1, 22, 43];
      const photoEntries = [];
      
      // ã¾ãšæœ€åˆã®æ•°è¡Œã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
      console.log('=== è¡Œ27-29ã®ã‚»ãƒ«å€¤ã‚’ç¢ºèª ===');
      for (let row = 27; row <= 29; row++) {
        for (const col of photoCols) {
          const cell = sheet.getCell(row, col);
          const text = getCellText(cell);
          console.log(`è¡Œ${row} åˆ—${col}: "${text.substring(0, 40)}..."`);
        }
      }
      
      // ã‚»ãƒ«ã‚’èµ°æŸ»ã—ã¦å†™çœŸãƒ©ãƒ™ãƒ«ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
      for (let row = 1; row <= sheet.rowCount; row++) {
        for (const col of photoCols) {
          const cell = sheet.getCell(row, col);
          const cellValue = getCellText(cell).trim();
          
          // å†™çœŸãƒ©ãƒ™ãƒ«ã‚’æ¤œå‡º
          if (cellValue.includes('å†™çœŸ') && 
              !cellValue.includes('ã‚³ãƒ¡ãƒ³ãƒˆ') && 
              !cellValue.includes('èª¿æŸ»') &&
              !cellValue.includes('ä½ç½®')) {
            
            // ãƒ©ãƒ™ãƒ«ã‚’æŠ½å‡ºï¼ˆæ‹¬å¼§ã‚’é™¤å»ï¼‰
            const labelMatch = cellValue.match(/[ï¼ˆ(]?(å†™çœŸ[ã‚¢-ãƒ³]+|å†™çœŸ[a-zA-Z0-9]+)[ï¼‰)]?/);
            const label = labelMatch ? labelMatch[1] : cellValue.replace(/[ï¼ˆ()ï¼‰]/g, '');
            
            // æ¬¡ã®è¡Œã®åŒã˜åˆ—ãŒã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‹ç¢ºèª
            const nextCell = sheet.getCell(row + 1, col);
            const nextValue = getCellText(nextCell);
            
            let comment = '';
            let commentRow = row + 1;
            
            if (nextValue.includes('ã‚³ãƒ¡ãƒ³ãƒˆ')) {
              // ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã®å¾Œã®å†…å®¹ã‚’å–å¾—
              // æ”¹è¡Œã§åˆ†å‰²ã—ã¦ã€æœ€åˆã®ã€Œï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã€è¡Œã‚’é™¤ã
              const lines = nextValue.split('\n');
              if (lines.length > 1) {
                // æœ€åˆã®è¡ŒãŒã€Œï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã€ã ã‘ã®å ´åˆã€æ®‹ã‚Šã‚’çµåˆ
                comment = lines.slice(1).join('\n').trim();
              } else {
                // æ”¹è¡ŒãŒãªã„å ´åˆã¯ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã‚’é™¤å»
                comment = nextValue
                  .replace(/[ï¼ˆ(]ã‚³ãƒ¡ãƒ³ãƒˆ[ï¼‰)]/g, '')
                  .trim();
              }
            }
            
            photoEntries.push({
              label: label,
              labelRow: row,
              labelCol: col,
              commentRow: commentRow,
              commentCol: col,
              comment: comment,
              imageBase64: null,
              isDummy: comment.trim() === '' // ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºãªã‚‰ãƒ€ãƒŸãƒ¼
            });
          }
        }
      }
      
      console.log('=== è§£æçµæœ ===');
      console.log('photoEntriesæ•°:', photoEntries.length);
      if (photoEntries.length > 0) {
        console.log('æœ€åˆã®ã‚¨ãƒ³ãƒˆãƒª:', photoEntries[0]);
        console.log('æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆ:', photoEntries[0].comment.substring(0, 50));
      }
      
      console.log(`ç”»åƒæ•°: ${imageDataList.length}`);
      
      // å†™çœŸã‚¨ãƒ³ãƒˆãƒªã‚‚è¡Œãƒ»åˆ—é †ã«ã‚½ãƒ¼ãƒˆ
      photoEntries.sort((a, b) => {
        if (a.labelRow !== b.labelRow) return a.labelRow - b.labelRow;
        return a.labelCol - b.labelCol;
      });
      
      console.log(`å†™çœŸã‚¨ãƒ³ãƒˆãƒªæ•°: ${photoEntries.length}`);
      console.log(`æ—¢å­˜ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚Šï¼‰: ${photoEntries.filter(e => !e.isDummy).length}`);
      console.log(`ãƒ€ãƒŸãƒ¼ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰: ${photoEntries.filter(e => e.isDummy).length}`);
      
      // ç”»åƒã‚’ã‚¢ãƒ³ã‚«ãƒ¼ä½ç½®ãƒ™ãƒ¼ã‚¹ã§å†™çœŸã‚¨ãƒ³ãƒˆãƒªã«ç´ä»˜ã‘
      // å„ç”»åƒã®tl(col)ã‹ã‚‰åˆ—ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åˆ¤å®šã—ã€tl(row)ãŒlabelRowã®ç›´ä¸Šã«ã‚ã‚‹ã‚¨ãƒ³ãƒˆãƒªã¨ãƒãƒƒãƒ
      imageDataList.forEach((img) => {
        // åˆ—ã‚°ãƒ«ãƒ¼ãƒ—åˆ¤å®š: Aåˆ—(1), Våˆ—(22), AQåˆ—(43)
        let colGroup;
        if (img.col < 15) colGroup = 1;
        else if (img.col < 35) colGroup = 22;
        else colGroup = 43;
        
        // åŒã˜åˆ—ã‚°ãƒ«ãƒ¼ãƒ—ã§ã€ç”»åƒãŒä¸Šã«ã‚ã‚‹ãƒ©ãƒ™ãƒ«ã®ã†ã¡æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’æ¢ã™
        let bestEntry = null;
        let bestDist = Infinity;
        
        for (const entry of photoEntries) {
          if (entry.labelCol !== colGroup) continue;
          // ç”»åƒã®tl.rowã¯ãƒ©ãƒ™ãƒ«è¡Œ(1-basedâ†’0-based: labelRow-1)ã‚ˆã‚Šä¸Šã«ã‚ã‚‹ã¯ãš
          const labelRow0 = entry.labelRow - 1;
          if (img.row < labelRow0) {
            const dist = labelRow0 - img.row;
            if (dist < bestDist) {
              bestDist = dist;
              bestEntry = entry;
            }
          }
        }
        
        if (bestEntry) {
          bestEntry.imageBase64 = img.dataUrl;
          console.log(`ç”»åƒãƒãƒƒãƒ: tl(row=${img.row.toFixed(1)}, col=${img.col.toFixed(1)}) â†’ ${bestEntry.label}`);
        }
      });
      
      photoData = photoEntries.map((entry, index) => ({
        index: index,
        label: entry.label,
        labelRow: entry.labelRow,
        labelCol: entry.labelCol,
        commentRow: entry.commentRow,
        commentCol: entry.commentCol,
        imageBase64: entry.imageBase64,
        comment: entry.comment,
        isDummy: !entry.imageBase64 && entry.comment.trim() === '', // ç”»åƒã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ãªã‘ã‚Œã°ãƒ€ãƒŸãƒ¼
        isModified: false
      }));
      
      console.log('Parsed photoData:', photoData);
      
      renderPhotoGrid();
      updateStats();
      hideLoading();
    }

    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    function updateStats() {
      const total = photoData.length;
      const withPhoto = photoData.filter(p => p.imageBase64).length;
      const dummy = photoData.filter(p => p.isDummy).length;
      
      document.getElementById('stats').innerHTML = `
        <span>ğŸ“· å†™çœŸ: ${withPhoto}æš</span>
        <span>ğŸ“ æ—¢å­˜: ${total - dummy}ä»¶</span>
        <span>â• ç©ºãæ : ${dummy}ä»¶</span>
      `;
    }

    // å†™çœŸã‚°ãƒªãƒƒãƒ‰æç”»
    function renderPhotoGrid() {
      photoGrid.innerHTML = '';
      
      photoData.forEach((photo, index) => {
        const card = document.createElement('div');
        card.className = 'photo-card' + (photo.isDummy ? ' is-dummy' : '');
        
        const labelClass = photo.isDummy ? 'photo-label dummy' : 'photo-label';
        
        card.innerHTML = `
          <div class="photo-frame" onclick="showActionSheet(${index})">
            <span class="${labelClass}">${photo.label}</span>
            ${photo.imageBase64 
              ? `<img src="${photo.imageBase64}" alt="${photo.label}">`
              : `<div class="placeholder">
                   <span class="placeholder-icon">ğŸ“·</span>
                   <span>ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±</span>
                 </div>`
            }
          </div>
          <div class="photo-info">
            <h3>ã‚³ãƒ¡ãƒ³ãƒˆ ${photo.isDummy ? 'ï¼ˆæ–°è¦ï¼‰' : ''}</h3>
            <textarea class="comment-input" 
                      placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."
                      onchange="updateComment(${index}, this.value)"
                      oninput="markAsModified(${index})"
            >${photo.comment}</textarea>
          </div>
        `;
        
        photoGrid.appendChild(card);
      });
    }

    // æ±ç”¨ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    function renderGenericSheet(sheet) {
      document.getElementById('stats').innerHTML = '';
      photoGrid.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #888;">
          <p style="font-size: 48px; margin-bottom: 20px;">ğŸ“„</p>
          <h3>${sheet.name}</h3>
          <p style="margin-top: 10px;">ã“ã®ã‚·ãƒ¼ãƒˆã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã™</p>
        </div>
      `;
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    function showActionSheet(photoIndex) {
      currentPhotoIndex = photoIndex;
      const photo = photoData[photoIndex];
      document.getElementById('action-sheet-title').textContent =
        photo.imageBase64 ? `${photo.label} - å†™çœŸã‚’å¤‰æ›´` : `${photo.label} - å†™çœŸã‚’è¿½åŠ `;

      actionSheet.classList.add('active');
      actionBackdrop.classList.add('active');
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆé–‰ã˜ã‚‹
    function closeActionSheet() {
      actionSheet.classList.remove('active');
      actionBackdrop.classList.remove('active');
    }

    // ã‚«ãƒ¡ãƒ©ã§æ’®å½±
    function openCamera() {
      closeActionSheet();
      cameraInput.click();
    }

    // å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠ
    function openPhotoLibrary() {
      closeActionSheet();
      photoInput.click();
    }

    // å†™çœŸã‚’CanvasçµŒç”±ã§æ­£è¦åŒ–ï¼ˆEXIFå›è»¢ã‚’é©ç”¨ã—ã€æ­£ã—ã„å‘ãã®JPEGã«ã™ã‚‹ï¼‰
    function normalizeImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);

        img.onload = () => {
          // Canvasã«æç”»ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãŒEXIF Orientationã‚’è‡ªå‹•é©ç”¨ã—ã¦ãã‚Œã‚‹ï¼‰
          const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);

          // JPEG 85%å“è³ªã§å‡ºåŠ›
          const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
          URL.revokeObjectURL(url);
          resolve(dataUrl);
        };

        img.onerror = () => {
          URL.revokeObjectURL(url);
          reject(new Error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        };

        img.src = url;
      });
    }

    // å†™çœŸé¸æŠãƒãƒ³ãƒ‰ãƒ©
    async function handlePhotoSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      showLoading('å†™çœŸã‚’å‡¦ç†ä¸­...');

      try {
        // CanvasçµŒç”±ã§æ­£è¦åŒ–ï¼ˆEXIFå›è»¢ã‚’é©ç”¨ã€ä¸Šä¸‹åè»¢ã‚’é˜²æ­¢ï¼‰
        const dataUrl = await normalizeImage(file);

        photoData[currentPhotoIndex].imageBase64 = dataUrl;
        photoData[currentPhotoIndex].isModified = true;
        photoData[currentPhotoIndex].isDummy = false;
        hasUnsavedChanges = true;
        renderPhotoGrid();
        updateStats();
        setStatus('å†™çœŸã‚’è¿½åŠ ã—ã¾ã—ãŸ', photoData[currentPhotoIndex].label);
      } catch (err) {
        console.error('å†™çœŸå‡¦ç†ã‚¨ãƒ©ãƒ¼:', err);
        alert('å†™çœŸã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      hideLoading();
      e.target.value = '';
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°
    function updateComment(index, value) {
      photoData[index].comment = value;
      photoData[index].isModified = true;
      hasUnsavedChanges = true;
    }
    
    // å¤‰æ›´ãƒãƒ¼ã‚¯
    function markAsModified(index) {
      if (!photoData[index].isModified) {
        photoData[index].isModified = true;
        hasUnsavedChanges = true;
      }
    }

    // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã®å¤‰æ›´ã‚’Excelã«æ›¸ãæˆ»ã—ã€Blobã‚’ç”Ÿæˆï¼ˆä¿å­˜å…±é€šå‡¦ç†ï¼‰
    async function prepareAndBuildBlob() {
      const sheet = workbook.getWorksheet(currentSheetName);

      // ã‚³ãƒ¡ãƒ³ãƒˆã‚’Excelã«æ›¸ãæˆ»ã™ï¼ˆ3åˆ—å¯¾å¿œï¼‰
      for (const photo of photoData) {
        if (photo.isModified && photo.commentRow && photo.commentCol) {
          const commentText = photo.comment
            ? `ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰\n${photo.comment}`
            : 'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰';

          const cell = sheet.getCell(photo.commentRow, photo.commentCol);
          cell.value = commentText;
        }
      }

      // ç”»åƒã®æŒ¿å…¥ï¼ˆæ–°è¦è¿½åŠ ãƒ»å¤‰æ›´åˆ†ï¼‰
      for (const photo of photoData) {
        if (photo.isModified && photo.imageBase64) {
          const match = photo.imageBase64.match(/^data:image\/(\w+);base64,(.+)$/);
          if (!match) continue;

          const extension = match[1] === 'jpg' ? 'jpeg' : match[1];
          const base64Data = match[2];

          const imageId = workbook.addImage({
            base64: base64Data,
            extension: extension,
          });

          // ãƒ©ãƒ™ãƒ«è¡Œã®ä¸Šã«ç”»åƒã‚’é…ç½®ï¼ˆ22.5è¡ŒÃ—19åˆ—ï¼‰
          const colStart = photo.labelCol;
          const colEnd = colStart + 19;
          const rowEnd = photo.labelRow - 1 - 0.1;
          const rowStart = rowEnd - 22.5;

          sheet.addImage(imageId, {
            tl: { col: colStart, row: rowStart },
            br: { col: colEnd, row: rowEnd },
            editAs: 'oneCell'
          });

          console.log(`ç”»åƒè¿½åŠ : ${photo.label} â†’ row${rowStart}-${rowEnd}, col${colStart}-${colEnd}`);
        }
      }

      // ä¿å­˜å‰ã«åˆ—å¹…ãƒ»è¡Œé«˜ã•ã‚’å¾©å…ƒï¼ˆExcelJSãŒå¤‰æ›´ã™ã‚‹ã®ã‚’é˜²ãï¼‰
      workbook.worksheets.forEach(ws => {
        const widths = savedColumnWidths[ws.name];
        if (widths) {
          for (const [colNum, width] of Object.entries(widths)) {
            ws.getColumn(Number(colNum)).width = width;
          }
        }
        const heights = savedRowHeights[ws.name];
        if (heights) {
          for (const [rowNum, height] of Object.entries(heights)) {
            const row = ws.getRow(Number(rowNum));
            row.height = height;
          }
        }
      });

      let buffer = await workbook.xlsx.writeBuffer();

      // ExcelJSãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…ã®åˆ—ã«ã‚‚ customWidth="1" ã‚’ä»˜ã‘ã¦ã—ã¾ã†å•é¡Œã‚’ä¿®æ­£
      // ã‚ªãƒªã‚¸ãƒŠãƒ«ã§ã¯width="9"ã®åˆ—ã«customWidthãŒãªã„ãŸã‚ã€Excelã®è¡¨ç¤ºåˆ—å¹…ãŒå¤‰ã‚ã‚‹
      buffer = await fixExcelJSColWidths(buffer);

      // PINãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°æš—å·åŒ–ã—ã¦ä¿å­˜
      if (appPIN) {
        showLoading('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æš—å·åŒ–ä¸­...');
        // xlsx-populateã§æš—å·åŒ–
        const encryptedBuffer = await encryptBuffer(buffer);
        return new Blob([encryptedBuffer], {
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        });
      }

      return new Blob([buffer], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    async function saveFile() {
      showLoading('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ä¸­...');
      
      try {
        const blob = await prepareAndBuildBlob();

        let saved = false;

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ãŒã‚ã‚‹å ´åˆ â†’ ä¸Šæ›¸ãä¿å­˜ã‚’è©¦è¡Œ
        if (fileHandle) {
          try {
            const writable = await fileHandle.createWritable();
            await writable.write(blob);
            await writable.close();
            saved = true;
            setStatus('ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ âœ“', currentFileName);
          } catch (err) {
            console.warn('ä¸Šæ›¸ãä¿å­˜å¤±æ•—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', err);
          }
        }

        // ä¸Šæ›¸ãä¿å­˜ã§ããªã‹ã£ãŸå ´åˆ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        if (!saved) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = currentFileName || 'slope_karte.xlsx';
          a.click();
          URL.revokeObjectURL(url);
          setStatus('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜ã—ã¾ã—ãŸ', currentFileName);
        }

        hasUnsavedChanges = false;
        photoData.forEach(p => p.isModified = false);
        hideLoading();
      } catch (error) {
        console.error('Save error:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        hideLoading();
      }
    }

    // æš—å·åŒ–ãªã—ä¿å­˜
    async function saveFileNoEncrypt() {
      showLoading('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ä¸­ï¼ˆæš—å·åŒ–ãªã—ï¼‰...');

      try {
        // æš—å·åŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ã€ä¸€æ™‚çš„ã«appPINã‚’nullã«ã™ã‚‹
        const savedPIN = appPIN;
        appPIN = null;
        const blob = await prepareAndBuildBlob();
        appPIN = savedPIN;

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFileName || 'slope_karte.xlsx';
        a.click();
        URL.revokeObjectURL(url);

        setStatus('ä¿å­˜ã—ã¾ã—ãŸï¼ˆæš—å·åŒ–ãªã—ï¼‰', currentFileName);
        hasUnsavedChanges = false;
        photoData.forEach(p => p.isModified = false);
        hideLoading();
      } catch (error) {
        console.error('Save error:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        hideLoading();
      }
    }

    // åˆ¥åä¿å­˜ï¼ˆä¿å­˜å…ˆã‚’é¸æŠï¼‰
    async function saveFileAs() {
      // showSaveFilePickerå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if ('showSaveFilePicker' in window) {
        showLoading('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ä¸­...');
        try {
          const blob = await prepareAndBuildBlob();

          const newHandle = await window.showSaveFilePicker({
            suggestedName: currentFileName || 'slope_karte.xlsx',
            types: [{
              description: 'Excel ãƒ•ã‚¡ã‚¤ãƒ«',
              accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }
            }]
          });
          const writable = await newHandle.createWritable();
          await writable.write(blob);
          await writable.close();

          // æ–°ã—ã„ãƒãƒ³ãƒ‰ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆ
          fileHandle = newHandle;
          currentFileName = newHandle.name;
          document.getElementById('current-file-name').textContent = currentFileName;
          document.getElementById('save-as-btn').style.display = 'inline-block';

          hasUnsavedChanges = false;
          photoData.forEach(p => p.isModified = false);
          setStatus('åˆ¥åä¿å­˜ã—ã¾ã—ãŸ âœ“', currentFileName);
          hideLoading();
        } catch (err) {
          hideLoading();
          if (err.name !== 'AbortError') {
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
          }
        }
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        saveFile();
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeFile() {
      if (hasUnsavedChanges) {
        if (!confirm('ä¿å­˜ã—ã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚é–‰ã˜ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
      }
      
      workbook = null;
      currentFileName = null;
      currentSheetName = null;
      photoData = [];
      hasUnsavedChanges = false;
      fileHandle = null;
      
      fileSelect.style.display = 'flex';
      editor.style.display = 'none';
      headerActions.style.display = 'none';
      statusBar.classList.remove('active');
      
      fileInput.value = '';
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function setStatus(status, info = '') {
      document.getElementById('status-text').textContent = status;
      document.getElementById('info-text').textContent = info;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading(text = 'èª­ã¿è¾¼ã¿ä¸­...') {
      document.getElementById('loading-text').textContent = text;
      loading.classList.add('active');
    }

    function hideLoading() {
      loading.classList.remove('active');
    }
  </script>
</body>
</html>
